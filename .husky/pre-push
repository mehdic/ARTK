#!/bin/sh
# Pre-push hook: sync deployed assets before pushing

set -e

# P0 FIX: Helper function for Windows detection with correct pattern matching
# Uses case statement instead of [[ ]] for POSIX sh compatibility
is_windows() {
  if [ -n "$WINDIR" ]; then
    return 0
  fi
  case "$(uname -s)" in
    MINGW*|MSYS*|CYGWIN*)
      return 0
      ;;
  esac
  return 1
}

# Sync VS Code extension prompts (cross-platform)
echo "Syncing VS Code extension prompts..."
if is_windows; then
  # Windows: use PowerShell
  powershell.exe -ExecutionPolicy Bypass -File "./scripts/sync-vscode-prompts.ps1"
else
  # Unix/macOS: use bash
  ./scripts/sync-vscode-prompts.sh
fi

if ! git diff --quiet -- packages/vscode-extension/assets/prompts; then
  echo "ERROR: packages/vscode-extension/assets/prompts changed. Please commit the updated prompts before pushing."
  exit 1
fi

# P0 FIX: Sync VS Code extension journeys (cross-platform)
echo "Syncing VS Code extension journeys..."
if is_windows; then
  # Windows: use PowerShell
  powershell.exe -ExecutionPolicy Bypass -File "./scripts/sync-vscode-journeys.ps1"
else
  # Unix/macOS: use bash
  ./scripts/sync-vscode-journeys.sh
fi

if ! git diff --quiet -- packages/vscode-extension/assets/journeys; then
  echo "ERROR: packages/vscode-extension/assets/journeys changed. Please commit the updated journeys before pushing."
  exit 1
fi

# Sync VS Code extension core assets (core dist, autogen dist, bootstrap templates)
echo "Syncing VS Code extension core assets..."
if is_windows; then
  powershell.exe -ExecutionPolicy Bypass -File "./scripts/sync-vscode-core-assets.ps1"
else
  ./scripts/sync-vscode-core-assets.sh
fi

if ! git diff --quiet -- packages/vscode-extension/assets/core packages/vscode-extension/assets/autogen packages/vscode-extension/assets/bootstrap-templates; then
  echo "ERROR: packages/vscode-extension/assets/{core,autogen,bootstrap-templates} changed. Please commit the updated assets before pushing."
  exit 1
fi

# Sync CLI assets
if [ ! -d "packages/cli/node_modules/ts-node" ]; then
  echo "Installing CLI dev dependencies..."
  npm --prefix packages/cli install --no-fund --no-audit
fi

echo "Syncing CLI assets..."
npm --prefix packages/cli run bundle-assets

if ! git diff --quiet -- packages/cli/assets; then
  echo "ERROR: packages/cli/assets changed. Please commit the updated assets before pushing."
  exit 1
fi
