#!/bin/sh
# Pre-push hook: sync deployed assets before pushing
#
# To skip asset sync (for faster pushes):
#   SKIP_ASSET_SYNC=1 git push
#
# To run asset sync manually:
#   ./scripts/sync-vscode-prompts.sh
#   npm --prefix packages/cli run bundle-assets

set -e

# Allow skipping asset sync for faster pushes
if [ "$SKIP_ASSET_SYNC" = "1" ]; then
  echo "⏭️  Skipping asset sync (SKIP_ASSET_SYNC=1)"
  exit 0
fi

# Sync VS Code extension prompts (cross-platform)
echo "Syncing VS Code extension prompts..."
if [ -n "$WINDIR" ] || [ "$(uname -s)" = "MINGW"* ] || [ "$(uname -s)" = "MSYS"* ]; then
  # Windows: use PowerShell
  powershell.exe -ExecutionPolicy Bypass -File "./scripts/sync-vscode-prompts.ps1"
else
  # Unix/macOS: use bash
  ./scripts/sync-vscode-prompts.sh
fi

if ! git diff --quiet -- packages/vscode-extension/assets/prompts; then
  echo "ERROR: packages/vscode-extension/assets/prompts changed. Please commit the updated prompts before pushing."
  exit 1
fi

# Sync CLI assets
if [ ! -d "packages/cli/node_modules/ts-node" ]; then
  echo "Installing CLI dev dependencies..."
  npm --prefix packages/cli install --no-fund --no-audit
fi

echo "Syncing CLI assets..."
npm --prefix packages/cli run bundle-assets

if ! git diff --quiet -- packages/cli/assets; then
  echo "ERROR: packages/cli/assets changed. Please commit the updated assets before pushing."
  exit 1
fi
