# /init - Initialize ARTK E2E Testing

## Purpose

Initialize ARTK E2E testing infrastructure in a project. This command:
1. Detects the git repository root
2. Scans for frontend applications using multi-signal heuristics
3. Creates the `artk-e2e/` directory with isolated dependencies
4. Generates `artk.config.yml` with discovered targets
5. Saves context to `.artk/context.json` for other prompts

## Usage

```
/init [--path <path>] [--skip-detection] [--force]
```

### Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--path <path>` | Override detected frontend path | Auto-detect |
| `--skip-detection` | Skip auto-detection, prompt for manual paths | false |
| `--force` | Overwrite existing `artk-e2e/` directory | false |

## Workflow

### Step 1: Detect Git Root

Find the repository root by traversing up from the current directory.

```typescript
import { execSync } from 'node:child_process';
import path from 'node:path';

function findGitRoot(startPath: string): string | null {
  try {
    const result = execSync('git rev-parse --show-toplevel', {
      cwd: startPath,
      encoding: 'utf-8',
    });
    return result.trim();
  } catch {
    return null;
  }
}

const gitRoot = findGitRoot(process.cwd());
if (!gitRoot) {
  console.error('Error: Not in a git repository. ARTK requires git for project structure detection.');
  process.exit(1);
}
```

### Step 2: Scan for Frontends

Use the ARTK detection module to discover frontend applications.

```typescript
import { FrontendDetector, SubmoduleChecker } from '@artk/core/detection';

const detector = new FrontendDetector();
const submoduleChecker = new SubmoduleChecker();

// Get submodule information for context
const submodules = await submoduleChecker.checkAll(gitRoot);

// Detect frontend applications
const results = await detector.detectAll(gitRoot, {
  maxDepth: 3,
  minScore: 20,        // Medium confidence threshold
  maxResults: 5,       // Hard limit per spec
  includeLowConfidence: false,
});

// Filter out uninitialized submodules (warn but continue)
for (const result of results) {
  const isInSubmodule = await submoduleChecker.isInSubmodule(result.path, gitRoot);
  if (isInSubmodule) {
    const submodule = submodules.find(s => result.path.startsWith(path.join(gitRoot, s.path)));
    if (submodule && !submodule.initialized) {
      console.warn(`Warning: ${result.relativePath} is in uninitialized submodule. Initialize with: git submodule update --init`);
    }
  }
}
```

### Step 3: Present Discovery Results

Display detected frontends for user confirmation.

```
=== ARTK E2E Initialization ===

Git Root: /path/to/project

Detected Frontend Applications:
  1. [HIGH] user-portal at ./iss-frontend (react-spa)
     Signals: package.json:react, src/App.tsx, directory:frontend
     Score: 65

  2. [HIGH] admin-portal at ./iss-admin (react-spa)
     Signals: package.json:react, src/main.tsx
     Score: 55

  3. [MEDIUM] web at ./packages/web (react-spa)
     Signals: package.json:next, pages/index.tsx
     Score: 35

Select targets to configure (comma-separated, or 'all'):
> 1,2

Optional: Add custom frontend path? (or press Enter to skip)
>
```

### Step 4: Handle Edge Cases

#### No Frontends Detected

```
No frontend applications detected automatically.

Common causes:
- Non-standard project structure
- Framework not recognized
- Source files in unexpected locations

Enter frontend path manually (relative to git root):
> ./my-app

What type of frontend is this?
1. react-spa (React SPA with Vite/CRA)
2. next (Next.js)
3. vue-spa (Vue with Vite)
4. nuxt (Nuxt)
5. angular (Angular)
6. other (Generic web app)
> 1
```

#### Existing artk-e2e/ Directory

```
Warning: artk-e2e/ directory already exists.

Options:
1. [Merge] Preserve existing tests, update config
2. [Rename] Move to artk-e2e.backup.<timestamp>/
3. [Overwrite] Delete and recreate (--force)
4. [Abort] Cancel initialization

Select option:
> 1
```

### Step 5: Create Directory Structure

```
artk-e2e/
├── vendor/
│   └── artk-core/          # Vendored @artk/core library
├── tests/
│   ├── user-portal/        # Tests for first target
│   └── admin-portal/       # Tests for second target
├── docs/
│   └── discovery/          # Discovery results per target
├── journeys/               # Journey definitions
├── .auth-states/           # Auth storage states per target
│   ├── user-portal/
│   └── admin-portal/
├── artk.config.yml         # Main configuration
├── playwright.config.ts    # Playwright configuration
├── package.json            # Isolated dependencies
└── tsconfig.json           # TypeScript configuration
```

### Step 6: Generate Configuration

#### artk.config.yml

```yaml
# ARTK E2E Configuration
# Generated by /init on <timestamp>
schemaVersion: "2.0"

targets:
  - name: user-portal
    path: ../iss-frontend
    type: react-spa
    detected_by:
      - package-dependency:react
      - entry-file:src/App.tsx
      - directory-name:frontend
    environments:
      local: http://localhost:3000
      # staging: https://staging.example.com
      # production: https://example.com

  - name: admin-portal
    path: ../iss-admin
    type: react-spa
    detected_by:
      - package-dependency:react
      - entry-file:src/main.tsx
    environments:
      local: http://localhost:3001

defaultTarget: user-portal
defaultEnvironment: local

auth:
  storageStateDir: ./.auth-states
  provider: oidc  # Adjust based on your auth system
  # Configure roles in auth.config.yml

settings:
  # Test execution settings
  parallel: true
  retries: 2
  timeout: 30000

  # Output settings
  outputDir: ./test-results
  traceOnFailure: true
```

#### .artk/context.json

```json
{
  "version": "1.0",
  "projectRoot": "/absolute/path/to/project",
  "artkRoot": "/absolute/path/to/project/artk-e2e",
  "targets": [
    {
      "name": "user-portal",
      "path": "../iss-frontend",
      "type": "react-spa"
    },
    {
      "name": "admin-portal",
      "path": "../iss-admin",
      "type": "react-spa"
    }
  ],
  "defaultTarget": "user-portal",
  "defaultEnvironment": "local",
  "initialized_at": "2025-01-15T10:30:00Z",
  "prompts_used": ["/init"],
  "next_suggested": "/discover"
}
```

### Step 7: Run Install Script

After configuration generation, run the install script to set up dependencies.

```typescript
import { runInstallScript } from '@artk/core/install';

await runInstallScript({
  artkRoot: path.join(gitRoot, 'artk-e2e'),
  vendorPath: path.join(gitRoot, 'artk-e2e', 'vendor', 'artk-core'),
  skipPlaywrightInstall: false,
});
```

### Step 8: Display Success

```
=== ARTK E2E Initialization Complete ===

Created: artk-e2e/
Targets: 2 frontends configured
Config:  artk.config.yml

Next steps:
1. Review artk.config.yml and update environment URLs
2. Run /discover to analyze your frontend applications
3. Run /foundation-build to create test harness
4. Run /journey-propose to generate initial test scenarios

To run tests:
  cd artk-e2e && npm test

Documentation: https://artk.dev/docs/getting-started
```

## Detection Algorithm

ARTK uses a multi-signal weighted scoring system for frontend detection:

### Signal Weights

| Signal Category | Weight Range | Description |
|-----------------|--------------|-------------|
| Package Dependencies | 30-35 | Framework packages (react, vue, next) |
| Entry Files | 15-20 | Common entry points (App.tsx, main.ts) |
| Directory Names | 10-15 | Naming conventions (frontend, client, web) |
| Index.html | 10 | Static HTML entry point |
| Config Files | 15-25 | Build tool configs (vite.config.ts) |

### Confidence Levels

| Level | Score | Interpretation |
|-------|-------|----------------|
| High | >= 40 | Strong frontend indicators |
| Medium | 20-39 | Likely frontend, confirm |
| Low | < 20 | Weak signals, manual review |

### Detection Priority

1. **Package.json analysis** (most reliable)
   - Framework dependencies: react, vue, @angular/core
   - Build tools: vite, webpack, next
   - Scoped packages: @angular/*, @vue/*

2. **Entry file patterns**
   - React: src/App.tsx, src/main.tsx
   - Next.js: app/page.tsx, pages/index.tsx
   - Vue: src/App.vue, src/main.ts
   - Angular: src/app/app.component.ts

3. **Directory heuristics**
   - High: frontend, client, webapp, web-app
   - Medium: web, app, ui
   - Excluded: backend, server, api, lib

4. **Submodule awareness**
   - Parse .gitmodules for structure
   - Warn on uninitialized submodules
   - Mark submodule boundaries

## Error Handling

### Common Errors

| Error | Cause | Resolution |
|-------|-------|------------|
| Not in git repository | No .git directory | Initialize git or cd to repo |
| No write permissions | Read-only filesystem | Check directory permissions |
| artk-e2e/ exists | Previous initialization | Use --force or merge option |
| Network unavailable | Cannot download deps | Use offline install mode |

### Recovery

If initialization fails partway:

```bash
# Remove partial install
rm -rf artk-e2e .artk

# Retry with verbose logging
/init --verbose
```

## Configuration Reference

See [artk.config.yml Schema](./schemas/config-schema.md) for full configuration options.

## Related Prompts

- `/discover` - Analyze frontend applications for routes and patterns
- `/foundation-build` - Create Playwright test harness
- `/journey-propose` - Generate test scenarios from discovery
