# LLKB-AutoGen Integration: Fix Tasks

**Created:** 2026-01-23
**Source:** Critical review at `research/2026-01-23_llkb-autogen-critical-review.md`
**Total Issues:** 12

---

## Priority Legend

- ðŸ”´ **CRITICAL** - Must fix before production use
- ðŸŸ¡ **MEDIUM** - Should fix in next sprint
- ðŸŸ¢ **LOW** - Nice to have / tech debt

---

## ðŸ”´ CRITICAL (4 Tasks)

### T001: Replace Custom YAML Generation with yaml Library

**File:** `core/typescript/llkb/adapter.ts`
**Lines:** 295-366

**Problem:**
The `generateYAML()` function manually builds YAML strings instead of using the `yaml` package. This risks generating invalid YAML when lesson triggers contain special characters (`&`, `*`, `!`, `@`, multi-line strings).

**Current Code:**
```typescript
function generateYAML(config: AutogenLLKBConfig): string {
  const lines: string[] = [];
  lines.push('# Generated by LLKB Adapter - DO NOT EDIT MANUALLY');
  // ... 70+ lines of manual string concatenation
}
```

**Fix:**
```typescript
import { stringify as yamlStringify } from 'yaml';

function generateYAML(config: AutogenLLKBConfig): string {
  const header = '# Generated by LLKB Adapter - DO NOT EDIT MANUALLY\n' +
                 '# Regenerate with: npx artk-llkb export --for-autogen\n';
  return header + yamlStringify(config, { lineWidth: 120 });
}
```

**Acceptance Criteria:**
- [ ] Replace manual YAML generation with `yaml.stringify()`
- [ ] Add test with special characters in lesson triggers
- [ ] Verify round-trip: export â†’ parse â†’ export produces identical output

---

### T002: Fix Type Error in learning.ts

**File:** `core/typescript/llkb/learning.ts`
**Line:** 548

**Problem:**
Lint error `Invalid type "never" of template literal expression` indicates TypeScript type narrowing issue. This was bypassed with `--no-verify` during commit.

**Current Code:**
```typescript
throw new Error(`Unknown learning event type: ${type}`);
// TypeScript narrows 'type' to 'never' but template literal doesn't accept it
```

**Fix:**
```typescript
// Option 1: Cast to string
throw new Error(`Unknown learning event type: ${type as string}`);

// Option 2: Use exhaustive check helper
function assertNever(x: never): never {
  throw new Error(`Unexpected value: ${String(x)}`);
}
// Then call: assertNever(type);
```

**Acceptance Criteria:**
- [ ] Fix type error without using `// @ts-ignore`
- [ ] Run `npm run lint` and confirm 0 errors in learning.ts
- [ ] All existing tests still pass

---

### T003: Add Atomic Operations for Version Tracking

**File:** `core/typescript/llkb/versioning.ts`
**Function:** `checkUpdates()` and related

**Problem:**
Race condition: If LLKB is updated between `checkUpdates()` and `update-test`, the version comparison becomes stale. Tests may claim LLKB version X while generated with version Y.

**Scenario:**
```
T1: checkUpdates() reads LLKB version "2026-01-23T10:00:00Z"
T2: journey-implement runs, LLKB updated to "2026-01-23T10:30:00Z"
T3: update-test uses stale comparison, writes wrong version header
```

**Fix Options:**

**Option A: Lock File**
```typescript
import { lockSync, unlockSync } from 'proper-lockfile';

async function atomicUpdateTest(testPath: string, llkbRoot: string) {
  const lockPath = join(llkbRoot, '.lock');
  await lockSync(lockPath);
  try {
    const comparison = compareVersions(testPath, llkbRoot);
    // ... perform update
  } finally {
    await unlockSync(lockPath);
  }
}
```

**Option B: Version Check at Write Time**
```typescript
function updateTestWithVersionCheck(
  testPath: string,
  expectedLlkbVersion: string,
  llkbRoot: string
): { success: boolean; versionMismatch?: boolean } {
  const currentVersion = getCurrentLlkbVersion(llkbRoot);
  if (currentVersion !== expectedLlkbVersion) {
    return { success: false, versionMismatch: true };
  }
  // ... perform update
}
```

**Acceptance Criteria:**
- [ ] Implement atomic version check mechanism
- [ ] Add test for concurrent update scenario
- [ ] Document the locking strategy in integration guide

---

### T004: Fix require() Usage in Test Files

**File:** `core/typescript/llkb/__tests__/learning.test.ts`
**Lines:** 296, 390

**Problem:**
Using CommonJS `require()` in ESM context violates linting rules and will break in strict ESM environments.

**Current Code:**
```typescript
const files = require('fs').readdirSync(testDir);
```

**Fix:**
```typescript
// At top of file, add import:
import { readdirSync } from 'node:fs';

// Then use:
const files = readdirSync(testDir);
```

**Acceptance Criteria:**
- [ ] Replace all `require()` calls with ES imports
- [ ] Run `npm run lint` - 0 `no-var-requires` errors
- [ ] Tests pass in ESM-only environment

---

## ðŸŸ¡ MEDIUM (5 Tasks)

### T005: Add runAdapterCLI Function

**File:** `core/typescript/llkb/adapter.ts`

**Problem:**
The specification defines `runAdapterCLI(args: string[]): Promise<void>` but implementation handles CLI through `cli.ts` only. This breaks modular design and testability.

**Specification:**
```typescript
export async function runAdapterCLI(args: string[]): Promise<void>;
```

**Fix:**
Add wrapper function in adapter.ts:
```typescript
export async function runAdapterCLI(args: string[]): Promise<void> {
  const parsed = parseAdapterArgs(args);
  const result = await exportForAutogen(parsed);
  console.log(formatExportResult(result));
}
```

**Acceptance Criteria:**
- [ ] Add `runAdapterCLI` function to adapter.ts
- [ ] Export from index.ts
- [ ] Add unit tests for CLI argument parsing
- [ ] Update documentation

---

### T006: Add Batch Operations to Learning Module

**File:** `core/typescript/llkb/learning.ts`

**Problem:**
Only single-event recording exists. Journey-verify often completes multiple steps, causing N file operations instead of 1.

**Current API:**
```typescript
recordComponentUsed(opts): Promise<Result>
recordLessonApplied(opts): Promise<Result>
recordPatternLearned(opts): Promise<Result>
```

**Add:**
```typescript
interface BatchLearningEvent {
  type: 'component' | 'lesson' | 'pattern';
  // ... event-specific fields
}

interface BatchResult {
  processed: number;
  failed: number;
  errors: Array<{ index: number; error: string }>;
}

export async function recordBatch(
  events: BatchLearningEvent[],
  llkbRoot?: string
): Promise<BatchResult>;
```

**Acceptance Criteria:**
- [ ] Implement `recordBatch()` function
- [ ] Single file read, single file write
- [ ] Atomic: all succeed or all fail
- [ ] Add tests for batch scenarios

---

### T007: Implement Rollback for Failed Updates

**File:** `core/typescript/llkb/versioning.ts`

**Problem:**
Specification Â§4.3 mentions automatic rollback on verification failure, but no rollback mechanism exists.

**Add:**
```typescript
interface UpdateTestOptions {
  testPath: string;
  llkbRoot?: string;
  verifyAfterUpdate?: boolean;  // Run test after update
  rollbackOnFailure?: boolean;  // Restore original on failure
}

interface UpdateTestResult {
  success: boolean;
  rolledBack?: boolean;
  originalBackupPath?: string;
  error?: string;
}

export async function updateTestSafe(
  options: UpdateTestOptions
): Promise<UpdateTestResult>;
```

**Acceptance Criteria:**
- [ ] Create backup before update
- [ ] Verify test runs after update (optional)
- [ ] Restore backup if verification fails
- [ ] Clean up backup on success

---

### T008: Standardize Error Handling Across Modules

**Files:** `adapter.ts`, `learning.ts`, `versioning.ts`

**Problem:**
Inconsistent error handling patterns:

| Module | Pattern |
|--------|---------|
| adapter.ts | Returns `{warnings: [...]}` |
| learning.ts | Returns `{success: false, error: string}` |
| versioning.ts | Throws exceptions |

**Fix:**
Create unified result type:
```typescript
// core/typescript/llkb/result-types.ts
export interface LLKBResult<T> {
  success: boolean;
  data?: T;
  error?: string;
  warnings: string[];
}

export function ok<T>(data: T, warnings: string[] = []): LLKBResult<T> {
  return { success: true, data, warnings };
}

export function fail<T>(error: string, warnings: string[] = []): LLKBResult<T> {
  return { success: false, error, warnings };
}
```

**Acceptance Criteria:**
- [ ] Create shared result type
- [ ] Refactor adapter.ts to use it
- [ ] Refactor learning.ts to use it
- [ ] Refactor versioning.ts to use it (no more throwing)
- [ ] Update all callers

---

### T009: Handle AutoGen Config Schema Breaking Change

**File:** `core/typescript/autogen/src/config/schema.ts`

**Problem:**
Adding `llkb` field with `.default({})` may break old code that doesn't expect this field.

**Fix:**
Add migration/compatibility layer:
```typescript
// In loader.ts
export function loadConfigWithMigration(configPath?: string): AutogenConfig {
  const config = loadConfig(configPath);

  // Ensure backward compatibility
  if (config.llkb === undefined) {
    config.llkb = { enabled: false };
  }

  return config;
}
```

**Acceptance Criteria:**
- [ ] Add explicit migration function
- [ ] Document schema version in config file
- [ ] Add test: old config loads without error
- [ ] Add CHANGELOG entry about schema change

---

## ðŸŸ¢ LOW (3 Tasks)

### T010: Add update-test Singular Command Alias

**File:** `core/typescript/llkb/cli.ts`

**Problem:**
Specification shows `update-test` (singular) but only `update-tests` (plural) exists.

**Fix:**
```typescript
// Add alias in CLI command registration
.command('update-test', 'Update a single test file (alias for update-tests --test)')
.alias('update-test', 'update-tests')
```

**Acceptance Criteria:**
- [ ] Add `update-test` as alias
- [ ] Update help text
- [ ] Add to README

---

### T011: Standardize Naming Conventions

**Files:** Various

**Problem:**
Inconsistent naming:
- `llkbGlossary` vs `llkb_glossary`
- `minConfidence` vs `min_confidence`
- `configPath` vs `config-path`

**Convention to Apply:**
- TypeScript variables/properties: camelCase (`llkbGlossary`, `minConfidence`)
- CLI arguments: kebab-case (`--min-confidence`, `--config-path`)
- Comments/docs: Match code style

**Acceptance Criteria:**
- [ ] Audit all naming inconsistencies
- [ ] Create naming convention doc
- [ ] Fix inconsistencies (may be breaking change for CLI)

---

### T012: Document Generated File Location Change

**Files:** `docs/llkb-autogen-integration.md`, CI scripts

**Problem:**
Files now generate to `artk-e2e/` by default instead of `.artk/`. CI scripts expecting old location will fail silently.

**Fix:**
- Update documentation with new paths
- Add migration note in CHANGELOG
- Consider backward-compatible flag: `--output .artk/` for old behavior

**Acceptance Criteria:**
- [ ] Update integration guide with new paths
- [ ] Add CHANGELOG entry
- [ ] Update any CI examples in docs

---

## Additional Issues Found During Lint

### T013: Fix Unused Imports

**Files:** Multiple test files

**Lint Errors:**
```
adapter.test.ts:34:15 - 'LLKBAdapterConfig' is defined but never used
learning.test.ts:24:15 - 'Component' is defined but never used
learning.test.ts:24:42 - 'Lesson' is defined but never used
versioning.test.ts:16:33 - 'readFileSync' is defined but never used
adapter.ts:34:15 - 'LLKBCategory' is defined but never used
```

**Fix:** Remove unused imports or prefix with underscore if intentionally unused.

**Acceptance Criteria:**
- [ ] Remove all unused imports
- [ ] Run lint with 0 unused-vars errors

---

### T014: Fix Magic Numbers

**Files:** `adapter-transforms.ts`, `cli.ts`, `learning.ts`, `versioning.ts`

**Problem:** 36 `no-magic-numbers` warnings for values like `0.5`, `100`, `300`, `1000`, `50`, etc.

**Fix:** Extract to named constants:
```typescript
// constants.ts
export const DEFAULT_CONFIDENCE_WEIGHT = 0.5;
export const MAX_TABLE_WIDTH = 100;
export const SHORT_TIMEOUT_MS = 300;
export const MEDIUM_TIMEOUT_MS = 1000;
export const LONG_TIMEOUT_MS = 2000;
export const DEFAULT_COLUMN_WIDTH = 50;
```

**Acceptance Criteria:**
- [ ] Create constants file
- [ ] Replace magic numbers with constants
- [ ] Run lint with 0 magic-number warnings

---

### T015: Fix Non-Null Assertions

**Files:** Test files

**Problem:** Multiple `Forbidden non-null assertion` warnings in tests.

**Current:**
```typescript
const version = result.data!.version;
```

**Fix:**
```typescript
expect(result.data).toBeDefined();
const version = result.data?.version;
// Or use assertion function
```

**Acceptance Criteria:**
- [ ] Replace `!` assertions with proper null checks
- [ ] Run lint with 0 non-null-assertion warnings

---

## Summary

| Priority | Count | Estimated Effort |
|----------|-------|------------------|
| ðŸ”´ CRITICAL | 4 | 8-12 hours |
| ðŸŸ¡ MEDIUM | 5 | 12-16 hours |
| ðŸŸ¢ LOW | 3 | 4-6 hours |
| Lint Fixes | 3 | 2-4 hours |
| **Total** | **15** | **26-38 hours** |

---

## Execution Order

**Phase 1: Lint Fixes (Day 1)**
- T013, T014, T015 (unblock CI)

**Phase 2: Critical Fixes (Day 2-3)**
- T002 (type error - quick fix)
- T004 (require fix - quick fix)
- T001 (YAML generation - medium)
- T003 (atomic operations - complex)

**Phase 3: Medium Priority (Day 4-5)**
- T008 (error handling - refactor)
- T006 (batch operations)
- T005 (CLI function)
- T007 (rollback)
- T009 (schema migration)

**Phase 4: Low Priority (Day 6)**
- T010, T011, T012 (polish)
