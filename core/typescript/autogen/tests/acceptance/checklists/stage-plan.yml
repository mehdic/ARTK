# Stage: Plan
# Verifies the plan command creates valid test generation plan

stage: plan
command: "artk-autogen plan"
description: "Create test generation plan from analysis"

prerequisites:
  - "Analysis JSON exists"
  - "State is 'analyzed'"

checks:
  # ═══════════════════════════════════════════════════════════════════════════
  # FILE ARTIFACTS
  # ═══════════════════════════════════════════════════════════════════════════
  - id: PLAN-001
    name: "Plan JSON created"
    type: file_exists
    path: ".artk/autogen/plan.json"
    severity: critical

  # ═══════════════════════════════════════════════════════════════════════════
  # PLAN CONTENT
  # ═══════════════════════════════════════════════════════════════════════════
  - id: PLAN-010
    name: "Strategy specified"
    type: json_contains
    path: ".artk/autogen/plan.json"
    field: "strategy"
    severity: high

  - id: PLAN-011
    name: "Test file path defined"
    type: json_contains
    path: ".artk/autogen/plan.json"
    field: "outputPath"
    severity: critical

  - id: PLAN-012
    name: "Steps mapped to test blocks"
    type: json_array_length
    path: ".artk/autogen/plan.json"
    field: "testBlocks"
    min: 1
    severity: high

  - id: PLAN-013
    name: "Each block has step reference"
    type: json_array_field_exists
    path: ".artk/autogen/plan.json"
    field: "testBlocks[*].stepId"
    severity: medium

  - id: PLAN-014
    name: "Fixtures identified"
    type: json_contains
    path: ".artk/autogen/plan.json"
    field: "fixtures"
    severity: medium

  - id: PLAN-015
    name: "Imports planned"
    type: json_contains
    path: ".artk/autogen/plan.json"
    field: "imports"
    severity: medium

  # ═══════════════════════════════════════════════════════════════════════════
  # STATE VALIDATION
  # ═══════════════════════════════════════════════════════════════════════════
  - id: PLAN-020
    name: "State transitioned to 'planned'"
    type: state_equals
    expected_stage: "planned"
    severity: critical

  - id: PLAN-021
    name: "Command recorded in history"
    type: state_history_contains
    command: "plan"
    severity: high

# ═══════════════════════════════════════════════════════════════════════════
# ERROR CASES
# ═══════════════════════════════════════════════════════════════════════════
error_cases:
  - id: PLAN-ERR-001
    name: "Rejects when state is initial"
    precondition_state: "initial"
    expected_exit_code: 1
    expected_output_contains: "analyze"

  - id: PLAN-ERR-002
    name: "Rejects when analysis.json missing"
    precondition: "delete .artk/autogen/analysis.json"
    expected_exit_code: 1
