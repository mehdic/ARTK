# Data Model: ARTK E2E Independent Architecture

**Feature**: 002-artk-e2e-independent-architecture | **Date**: 2025-12-30

## Entities

### 1. ArtkContext

**Purpose**: Persistent state for inter-prompt communication.

**Location**: `artk-e2e/.artk/context.json`

**Lifecycle**: Created by `/init`, read by all prompts, updated by `/discover`, committed to version control.

```typescript
interface ArtkContext {
  /** Schema version for migration support */
  version: "1.0";

  /** When this context was created */
  initialized_at: string; // ISO8601

  /** Project metadata */
  project: {
    /** Human-readable project name */
    name: string;
    /** Relative path to project root from artk-e2e/ */
    root: string;
  };

  /** Configured frontend targets (1-5 max) */
  targets: ArtkTarget[];

  /** Installation metadata */
  install: {
    artk_core_version: string;
    playwright_version: string;
    script_path: string;
  };
}
```

---

### 2. ArtkTarget

**Purpose**: Represents a frontend application to test.

**Constraints**: Maximum 5 targets per project.

```typescript
interface ArtkTarget {
  /** Unique identifier, lowercase-kebab-case */
  name: string;

  /** Relative path to frontend directory from artk-e2e/ */
  path: string;

  /** Detected or specified application type */
  type: 'react-spa' | 'vue-spa' | 'angular' | 'next' | 'nuxt' | 'other';

  /** Signals that identified this target during detection */
  detected_by: string[];

  /** Optional description */
  description?: string;
}
```

---

### 3. ArtkConfig

**Purpose**: Main configuration file for ARTK E2E suite.

**Location**: `artk-e2e/artk.config.yml`

**Lifecycle**: Generated by `/init`, edited by user, read by all prompts and Playwright config.

```typescript
interface ArtkConfig {
  /** Schema version for backward compatibility */
  schemaVersion: "2.0";

  /** Project metadata */
  project: {
    name: string;
    description?: string;
  };

  /** Frontend targets with environment URLs */
  targets: ArtkConfigTarget[];

  /** Default settings */
  defaults: {
    target: string; // must match a target name
    environment: string; // e.g., 'local', 'staging'
  };

  /** Authentication configuration */
  auth?: ArtkAuthConfig;

  /** Browser settings */
  browsers?: {
    enabled: ('chromium' | 'firefox' | 'webkit')[];
    headless: boolean;
  };

  /** Timeout settings in milliseconds */
  timeouts?: {
    default: number;
    navigation: number;
    auth: number;
  };
}
```

---

### 4. ArtkConfigTarget

**Purpose**: Extended target configuration with per-environment URLs.

```typescript
interface ArtkConfigTarget {
  /** Unique identifier */
  name: string;

  /** Relative path to frontend directory */
  path: string;

  /** Application type */
  type: 'react-spa' | 'vue-spa' | 'angular' | 'next' | 'nuxt' | 'other';

  /** Optional description */
  description?: string;

  /** Environment-specific URLs */
  environments: {
    [envName: string]: {
      baseUrl: string;
      apiUrl?: string;
    };
  };
}
```

---

### 5. ArtkAuthConfig

**Purpose**: Authentication provider configuration.

```typescript
interface ArtkAuthConfig {
  /** Auth provider type */
  provider: 'oidc' | 'saml' | 'basic' | 'custom';

  /** Identity provider type (for OIDC) */
  idpType?: 'keycloak' | 'auth0' | 'okta' | 'azure-ad' | 'other';

  /** Directory for storage states (relative to artk-e2e/) */
  storageStateDir: string; // default: '.auth-states'

  /** Per-environment auth URLs */
  environments: {
    [envName: string]: {
      loginUrl: string;
      logoutUrl?: string;
    };
  };

  /** Role definitions */
  roles: {
    [roleName: string]: ArtkRole;
  };
}
```

---

### 6. ArtkRole

**Purpose**: A user role with credentials from environment variables.

```typescript
interface ArtkRole {
  /** Environment variable names for credentials */
  credentialsEnv: {
    username: string; // e.g., 'ISS_USER'
    password: string; // e.g., 'ISS_PASSWORD'
  };

  /** TOTP secret env var (if MFA enabled) */
  totpSecretEnv?: string;

  /** Per-target storage state overrides */
  storageState?: {
    [targetName: string]: string; // path to storage state file
  };
}
```

---

### 7. DetectionResult

**Purpose**: Result of frontend detection heuristics during `/init`.

**Transient**: Not persisted, used only during detection.

```typescript
interface DetectionResult {
  /** Absolute path to detected frontend */
  path: string;

  /** Detection confidence level */
  confidence: 'high' | 'medium' | 'low';

  /** Detected application type */
  type: 'react-spa' | 'vue-spa' | 'angular' | 'next' | 'nuxt' | 'other';

  /** Detection signals that matched */
  signals: string[];

  /** Combined score from weighted signals */
  score: number;
}
```

---

### 8. SubmoduleStatus

**Purpose**: Git submodule state for warning users.

**Transient**: Not persisted.

```typescript
interface SubmoduleStatus {
  /** Path to submodule (from .gitmodules) */
  path: string;

  /** Whether the submodule is initialized */
  initialized: boolean;

  /** Commit SHA if initialized */
  commit?: string;
}
```

---

## Entity Relationships

```
ArtkContext (1) ───contains───> (1-5) ArtkTarget
     │
     └── install metadata (versions)

ArtkConfig (1) ───contains───> (1-5) ArtkConfigTarget
     │                              │
     │                              └── environments (n URLs)
     │
     └── auth ───> ArtkAuthConfig
                        │
                        └── roles ───> (n) ArtkRole

DetectionResult ─────derived-from────> ArtkTarget
     │
     └── score (weighted signals)

SubmoduleStatus ─────warns-about────> ArtkTarget.path
```

---

## Validation Rules

### ArtkContext
- `version` must be "1.0"
- `targets` array must have 1-5 elements
- `targets[].path` must be relative (not absolute, no leading `/`)
- `targets[].name` must be unique within array
- `install.artk_core_version` must be valid semver

### ArtkConfig
- `schemaVersion` must be "2.0"
- `targets` array must have 1-5 elements
- `defaults.target` must match a `targets[].name`
- `defaults.environment` must exist in all targets' `environments`
- All paths must be relative
- URL values must be valid URLs
- Timeout values must be positive integers

### ArtkTarget / ArtkConfigTarget
- `name` must match pattern `^[a-z][a-z0-9-]*$`
- `path` must not start with `/` or contain `..` escaping project root
- `type` must be one of the allowed enum values

### ArtkRole
- `credentialsEnv.username` and `credentialsEnv.password` must be non-empty strings
- Environment variable names should match pattern `^[A-Z][A-Z0-9_]*$`

---

## Storage Locations

| Entity | Format | Location | Committed |
|--------|--------|----------|-----------|
| ArtkContext | JSON | `artk-e2e/.artk/context.json` | Yes |
| ArtkConfig | YAML | `artk-e2e/artk.config.yml` | Yes |
| DetectionResult | - | In-memory during /init | No |
| SubmoduleStatus | - | In-memory during /init | No |
| Auth Storage States | JSON | `artk-e2e/.auth-states/{target}/` | No (gitignored) |

---

## Schema Evolution

### Context Schema Migration (future v2.0)
```typescript
function migrateContext(old: ArtkContext): ArtkContext {
  if (old.version === "1.0") {
    // Future: migrate to 2.0
    return {
      ...old,
      version: "2.0" as const,
      // new fields with defaults
    };
  }
  return old;
}
```

### Config Schema Migration (v1 → v2)
```typescript
function migrateConfig(old: unknown): ArtkConfig {
  // Detect v1 by missing schemaVersion
  if (!('schemaVersion' in old)) {
    return {
      schemaVersion: "2.0",
      project: {
        name: (old as any).app?.name || "migrated-project",
      },
      targets: [{
        name: "default",
        path: "../frontend",
        type: "other",
        environments: {
          local: { baseUrl: (old as any).app?.baseUrl || "http://localhost:3000" }
        }
      }],
      defaults: {
        target: "default",
        environment: "local"
      }
    };
  }
  return old as ArtkConfig;
}
```
