{"version":3,"sources":["../../compat/detect-env.ts","../../compat/dirname.ts","../../compat/project-root.ts","../../compat/dynamic-import.ts"],"names":["path"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Runtime Environment Detection\n *\n * Detects whether code is running in CommonJS or ESM context at runtime.\n * Zero external dependencies (FR-018).\n *\n * @module @artk/core/compat/detect-env\n */\n\n/**\n * Module system identifier\n */\nexport type ModuleSystemRuntime = 'commonjs' | 'esm' | 'unknown';\n\n/**\n * Cached module system result for performance\n */\nlet cachedModuleSystem: ModuleSystemRuntime | null = null;\n\n/**\n * Detects the current runtime module system (FR-015)\n *\n * Detection strategy:\n * 1. Check for import.meta (ESM indicator)\n * 2. Check for __dirname (CommonJS indicator)\n * 3. Return 'unknown' if neither available\n *\n * Results are cached for performance (< 1ms after first call).\n *\n * @returns Module system identifier: 'commonjs', 'esm', or 'unknown'\n *\n * @example\n * ```typescript\n * import { getModuleSystem } from '@artk/core/compat';\n *\n * const system = getModuleSystem();\n * if (system === 'esm') {\n *   console.log('Running in ESM mode');\n * }\n * ```\n */\nexport function getModuleSystem(): ModuleSystemRuntime {\n  // Return cached result if available\n  if (cachedModuleSystem !== null) {\n    return cachedModuleSystem;\n  }\n\n  // Check for ESM - import.meta is only available in ESM\n  // We use a try-catch because just referencing import.meta in CommonJS throws\n  try {\n    if (typeof import.meta !== 'undefined' && import.meta.url) {\n      cachedModuleSystem = 'esm';\n      return cachedModuleSystem;\n    }\n  } catch {\n    // import.meta not available - not ESM\n  }\n\n  // Check for CommonJS - __dirname is only available in CommonJS\n  try {\n    // In ESM, __dirname is not defined\n    // In CommonJS, it's always a string\n    if (typeof __dirname !== 'undefined' && typeof __dirname === 'string') {\n      cachedModuleSystem = 'commonjs';\n      return cachedModuleSystem;\n    }\n  } catch {\n    // __dirname not available - not CommonJS\n  }\n\n  // Neither indicator found\n  cachedModuleSystem = 'unknown';\n  return cachedModuleSystem;\n}\n\n/**\n * Checks if code is running in ESM context\n *\n * @returns true if running in ESM, false otherwise\n *\n * @example\n * ```typescript\n * import { isESM } from '@artk/core/compat';\n *\n * if (isESM()) {\n *   // Use import.meta.url\n * } else {\n *   // Use __dirname\n * }\n * ```\n */\nexport function isESM(): boolean {\n  return getModuleSystem() === 'esm';\n}\n\n/**\n * Checks if code is running in CommonJS context\n *\n * @returns true if running in CommonJS, false otherwise\n *\n * @example\n * ```typescript\n * import { isCommonJS } from '@artk/core/compat';\n *\n * if (isCommonJS()) {\n *   // Use require()\n * } else {\n *   // Use dynamic import()\n * }\n * ```\n */\nexport function isCommonJS(): boolean {\n  return getModuleSystem() === 'commonjs';\n}\n\n/**\n * Resets the cached module system (for testing purposes only)\n * @internal\n */\nexport function _resetCache(): void {\n  cachedModuleSystem = null;\n}\n","/**\n * Directory Name Compatibility\n *\n * Provides cross-environment utilities for getting directory and file paths.\n * Works in both CommonJS (__dirname) and ESM (import.meta.url) contexts.\n * Zero external dependencies (FR-018).\n *\n * @module @artk/core/compat/dirname\n */\n\nimport { fileURLToPath } from 'url';\nimport * as path from 'path';\n\n/**\n * Gets the directory name from an import.meta.url (FR-012)\n *\n * This is the ESM equivalent of __dirname. Use this in ESM modules\n * to get the directory containing the current file.\n *\n * Note: In Node 20.11.0+, you can use import.meta.dirname directly.\n * This function provides compatibility for Node 18+.\n *\n * @param metaUrl - The import.meta.url of the calling module\n * @returns Absolute path to the directory containing the module\n * @throws Error if metaUrl is invalid or empty\n *\n * @example\n * ```typescript\n * // In an ESM module\n * import { getDirname } from '@artk/core/compat';\n *\n * const __dirname = getDirname(import.meta.url);\n * const configPath = path.join(__dirname, 'config.json');\n * ```\n */\nexport function getDirname(metaUrl: string): string {\n  if (!metaUrl) {\n    throw new Error('import.meta.url is required to get dirname');\n  }\n\n  // Handle file:// URLs\n  if (metaUrl.startsWith('file://')) {\n    try {\n      const filePath = fileURLToPath(metaUrl);\n      return path.dirname(filePath);\n    } catch (error) {\n      throw new Error(\n        `Failed to convert URL to path: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  // Handle already-converted paths (shouldn't happen but be defensive)\n  if (path.isAbsolute(metaUrl)) {\n    return path.dirname(metaUrl);\n  }\n\n  throw new Error(\n    `Invalid import.meta.url: \"${metaUrl}\". Expected a file:// URL.`\n  );\n}\n\n/**\n * Gets the filename from an import.meta.url\n *\n * This is the ESM equivalent of __filename. Use this in ESM modules\n * to get the full path to the current file.\n *\n * @param metaUrl - The import.meta.url of the calling module\n * @returns Absolute path to the module file\n * @throws Error if metaUrl is invalid or empty\n *\n * @example\n * ```typescript\n * // In an ESM module\n * import { getFilename } from '@artk/core/compat';\n *\n * const __filename = getFilename(import.meta.url);\n * console.log(`Running: ${__filename}`);\n * ```\n */\nexport function getFilename(metaUrl: string): string {\n  if (!metaUrl) {\n    throw new Error('import.meta.url is required to get filename');\n  }\n\n  // Handle file:// URLs\n  if (metaUrl.startsWith('file://')) {\n    try {\n      return fileURLToPath(metaUrl);\n    } catch (error) {\n      throw new Error(\n        `Failed to convert URL to path: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  // Handle already-converted paths\n  if (path.isAbsolute(metaUrl)) {\n    return metaUrl;\n  }\n\n  throw new Error(\n    `Invalid import.meta.url: \"${metaUrl}\". Expected a file:// URL.`\n  );\n}\n\n/**\n * Creates __dirname and __filename equivalents for an ESM module\n *\n * Convenience function that returns both values at once.\n *\n * @param metaUrl - The import.meta.url of the calling module\n * @returns Object with dirname and filename\n *\n * @example\n * ```typescript\n * import { createDirnameMeta } from '@artk/core/compat';\n *\n * const { dirname, filename } = createDirnameMeta(import.meta.url);\n * // dirname === path.dirname(__filename)\n * // filename === full path to current file\n * ```\n */\nexport function createDirnameMeta(metaUrl: string): {\n  dirname: string;\n  filename: string;\n} {\n  const filename = getFilename(metaUrl);\n  return {\n    dirname: path.dirname(filename),\n    filename,\n  };\n}\n","/**\n * Project Root Resolution\n *\n * Utilities for finding the project root directory by locating package.json.\n * Works in both CommonJS and ESM contexts.\n * Zero external dependencies (FR-018).\n *\n * @module @artk/core/compat/project-root\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\n\n/**\n * Cached project root for performance\n */\nlet cachedProjectRoot: string | null = null;\n\n/**\n * Finds the nearest package.json by walking up the directory tree\n *\n * @param startDir - Directory to start searching from\n * @returns Absolute path to package.json, or null if not found\n *\n * @example\n * ```typescript\n * import { findPackageJson } from '@artk/core/compat';\n *\n * const pkgPath = findPackageJson('/path/to/project/src/deep/module');\n * // Returns '/path/to/project/package.json' if it exists\n * ```\n */\nexport function findPackageJson(startDir: string): string | null {\n  // Normalize and make absolute\n  let currentDir = path.resolve(startDir);\n  const root = path.parse(currentDir).root;\n\n  while (currentDir !== root) {\n    const packageJsonPath = path.join(currentDir, 'package.json');\n\n    if (fs.existsSync(packageJsonPath)) {\n      return packageJsonPath;\n    }\n\n    // Move up one directory\n    const parentDir = path.dirname(currentDir);\n\n    // Check if we've reached the root\n    if (parentDir === currentDir) {\n      break;\n    }\n\n    currentDir = parentDir;\n  }\n\n  // Check root directory as well\n  const rootPackageJson = path.join(root, 'package.json');\n  if (fs.existsSync(rootPackageJson)) {\n    return rootPackageJson;\n  }\n\n  return null;\n}\n\n/**\n * Resolves the project root directory (FR-013)\n *\n * Finds the nearest directory containing package.json by walking up\n * from the current working directory. Results are cached for performance.\n *\n * @param startDir - Optional starting directory (defaults to cwd)\n * @returns Absolute path to project root\n * @throws Error if no package.json found\n *\n * @example\n * ```typescript\n * import { resolveProjectRoot } from '@artk/core/compat';\n *\n * const root = resolveProjectRoot();\n * const configPath = path.join(root, 'artk.config.yml');\n * ```\n */\nexport function resolveProjectRoot(startDir?: string): string {\n  // Use cache for default (cwd) case\n  if (!startDir && cachedProjectRoot !== null) {\n    return cachedProjectRoot;\n  }\n\n  const searchStart = startDir || process.cwd();\n  const packageJsonPath = findPackageJson(searchStart);\n\n  if (!packageJsonPath) {\n    throw new Error(\n      `Cannot determine project root: No package.json found starting from \"${searchStart}\". ` +\n      'Make sure you are running from within a Node.js project.'\n    );\n  }\n\n  const projectRoot = path.dirname(packageJsonPath);\n\n  // Cache only for default (cwd) case\n  if (!startDir) {\n    cachedProjectRoot = projectRoot;\n  }\n\n  return projectRoot;\n}\n\n/**\n * Gets the project's package.json contents\n *\n * @param startDir - Optional starting directory\n * @returns Parsed package.json contents\n * @throws Error if package.json not found or invalid\n *\n * @example\n * ```typescript\n * import { getPackageJson } from '@artk/core/compat';\n *\n * const pkg = getPackageJson();\n * console.log(`Project: ${pkg.name}@${pkg.version}`);\n * ```\n */\nexport function getPackageJson(startDir?: string): Record<string, unknown> {\n  const root = resolveProjectRoot(startDir);\n  const packageJsonPath = path.join(root, 'package.json');\n\n  try {\n    const content = fs.readFileSync(packageJsonPath, 'utf8');\n    return JSON.parse(content);\n  } catch (error) {\n    throw new Error(\n      `Failed to read package.json at \"${packageJsonPath}\": ` +\n      `${error instanceof Error ? error.message : 'Unknown error'}`\n    );\n  }\n}\n\n/**\n * Resets the cached project root (for testing purposes only)\n * @internal\n */\nexport function _resetCache(): void {\n  cachedProjectRoot = null;\n}\n","/**\n * Dynamic Import Compatibility\n *\n * Provides cross-environment dynamic module loading.\n * Works in both CommonJS (require) and ESM (import()) contexts.\n * Zero external dependencies (FR-018).\n *\n * @module @artk/core/compat/dynamic-import\n */\n\n/**\n * Dynamically imports a module (FR-014)\n *\n * Provides a unified API for dynamic imports that works in both\n * CommonJS and ESM environments. Uses native `import()` which is\n * available in Node 12+ for CommonJS and all versions of ESM.\n *\n * @param specifier - Module specifier (e.g., './config', '@artk/core', 'fs')\n * @returns Promise that resolves to the imported module\n * @throws Error if module cannot be loaded\n *\n * @example\n * ```typescript\n * import { dynamicImport } from '@artk/core/compat';\n *\n * // Import a built-in module\n * const fs = await dynamicImport<typeof import('fs')>('fs');\n *\n * // Import a package\n * const yaml = await dynamicImport('yaml');\n *\n * // Import a relative module\n * const config = await dynamicImport('./config.js');\n * ```\n */\nexport async function dynamicImport<T = unknown>(specifier: string): Promise<T> {\n  if (!specifier) {\n    throw new Error('Module specifier is required');\n  }\n\n  try {\n    // Native dynamic import works in both CommonJS (Node 12+) and ESM\n    const module = await import(specifier);\n    return module as T;\n  } catch (error) {\n    // Provide a more helpful error message\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    throw new Error(`Failed to import module \"${specifier}\": ${message}`);\n  }\n}\n\n/**\n * Dynamically imports a module and returns its default export\n *\n * Convenience function for modules that primarily use default exports.\n *\n * @param specifier - Module specifier\n * @returns Promise that resolves to the default export\n * @throws Error if module cannot be loaded or has no default export\n *\n * @example\n * ```typescript\n * import { dynamicImportDefault } from '@artk/core/compat';\n *\n * const yaml = await dynamicImportDefault('yaml');\n * const parsed = yaml.parse('key: value');\n * ```\n */\nexport async function dynamicImportDefault<T = unknown>(specifier: string): Promise<T> {\n  const module = await dynamicImport<{ default?: T }>(specifier);\n\n  if ('default' in module) {\n    return module.default as T;\n  }\n\n  // Some modules don't use default exports, return the whole module\n  return module as unknown as T;\n}\n\n/**\n * Safely tries to import a module, returning null if not found\n *\n * Useful for optional dependencies or feature detection.\n *\n * @param specifier - Module specifier\n * @returns Promise that resolves to the module or null if not found\n *\n * @example\n * ```typescript\n * import { tryDynamicImport } from '@artk/core/compat';\n *\n * const optionalDep = await tryDynamicImport('optional-package');\n * if (optionalDep) {\n *   // Use the optional dependency\n * }\n * ```\n */\nexport async function tryDynamicImport<T = unknown>(\n  specifier: string\n): Promise<T | null> {\n  try {\n    return await dynamicImport<T>(specifier);\n  } catch {\n    return null;\n  }\n}\n"]}