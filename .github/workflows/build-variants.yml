name: Build and Test Variants

on:
  push:
    branches: [main, 'release/**']
    paths:
      - 'core/typescript/**'
      - 'cli/**'
      - '.github/workflows/build-variants.yml'
  pull_request:
    branches: [main]
    paths:
      - 'core/typescript/**'
      - 'cli/**'
      - '.github/workflows/build-variants.yml'
  workflow_dispatch:
    inputs:
      variant:
        description: 'Specific variant to build (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - 'modern-esm'
          - 'modern-cjs'
          - 'legacy-16'
          - 'legacy-14'

jobs:
  build-variants:
    name: Build All Variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: core/typescript/package.json

      - name: Install dependencies
        run: |
          npm install
          cd autogen && npm install
        working-directory: core/typescript

      - name: Build all variants
        run: |
          export NODE_OPTIONS="--max-old-space-size=6144"

          echo "Building modern-esm..."
          npm run build

          echo "Building modern-cjs..."
          npm run build:cjs

          echo "Building legacy-16..."
          npm run build:legacy-16

          echo "Building legacy-14..."
          npm run build:legacy-14
        working-directory: core/typescript

      - name: Verify build outputs
        run: |
          # Check all dist directories exist with correct entry points
          # ESM builds produce .js, CJS builds produce .cjs

          # ESM variant
          if [ ! -d "dist" ]; then
            echo "ERROR: Missing dist directory"
            exit 1
          fi
          if [ ! -f "dist/index.js" ]; then
            echo "ERROR: Missing dist/index.js (ESM)"
            exit 1
          fi
          echo "✓ dist exists and contains index.js (ESM)"

          # CJS variants produce .cjs files
          for dir in dist-cjs dist-legacy-16 dist-legacy-14; do
            if [ ! -d "$dir" ]; then
              echo "ERROR: Missing $dir directory"
              exit 1
            fi
            if [ ! -f "$dir/index.cjs" ]; then
              echo "ERROR: Missing $dir/index.cjs (CJS)"
              exit 1
            fi
            echo "✓ $dir exists and contains index.cjs (CJS)"
          done

          # Verify type declarations exist for all variants
          echo ""
          echo "Checking type declarations..."
          for dir in dist dist-cjs dist-legacy-16 dist-legacy-14; do
            if [ ! -f "$dir/index.d.ts" ]; then
              echo "ERROR: Missing $dir/index.d.ts (types)"
              exit 1
            fi
            echo "✓ $dir/index.d.ts exists"
          done
        working-directory: core/typescript

      - name: Verify ESM variant loads
        run: |
          node --input-type=module -e "
            import('./dist/index.js').then(m => {
              const count = Object.keys(m).length;
              console.log('ESM variant loaded successfully, exports:', count);
              if (count === 0) { console.error('ERROR: No exports found'); process.exit(1); }
              if (!m.ARTKConfigError) { console.error('ERROR: Missing ARTKConfigError export'); process.exit(1); }
            }).catch(e => { console.error('ESM load failed:', e); process.exit(1); });
          "
        working-directory: core/typescript

      - name: Verify modern-cjs variant loads
        run: |
          node -e "
            const m = require('./dist-cjs/index.cjs');
            const count = Object.keys(m).length;
            console.log('Modern-CJS variant loaded successfully, exports:', count);
            if (count === 0) { console.error('ERROR: No exports found'); process.exit(1); }
            if (!m.ARTKConfigError) { console.error('ERROR: Missing ARTKConfigError export'); process.exit(1); }
          "
        working-directory: core/typescript

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artk-core-variants
          path: |
            core/typescript/dist
            core/typescript/dist-cjs
            core/typescript/dist-legacy-16
            core/typescript/dist-legacy-14
          retention-days: 7

  test-node-22:
    name: Test on Node 22 (Modern)
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: core/typescript/package.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artk-core-variants
          path: .

      - name: Install dependencies
        run: |
          npm install
          cd autogen && npm install
        working-directory: core/typescript

      - name: Install Playwright browsers
        run: npx playwright install chromium
        working-directory: core/typescript

      - name: Run unit tests
        run: npm run test:unit
        working-directory: core/typescript

  test-node-20:
    name: Test on Node 20 (Modern)
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: core/typescript/package.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artk-core-variants
          path: .

      - name: Install dependencies
        run: |
          npm install
          cd autogen && npm install
        working-directory: core/typescript

      - name: Install Playwright browsers
        run: npx playwright install chromium
        working-directory: core/typescript

      - name: Run unit tests
        run: npm run test:unit
        working-directory: core/typescript

  test-node-18:
    name: Test on Node 18 (Modern)
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: core/typescript/package.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artk-core-variants
          path: .

      - name: Install dependencies
        run: |
          npm install
          cd autogen && npm install
        working-directory: core/typescript

      - name: Install Playwright browsers
        run: npx playwright install chromium
        working-directory: core/typescript

      - name: Run unit tests
        run: npm run test:unit
        working-directory: core/typescript

  test-node-16:
    name: Test on Node 16 (Legacy-16)
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artk-core-variants
          path: .

      - name: Install dependencies (legacy)
        run: |
          # Use legacy-16 package.json for correct module system and Playwright version
          cp package.json package.json.backup
          cp package-legacy-16.json package.json
          npm install --legacy-peer-deps
        working-directory: core/typescript

      - name: Verify legacy-16 variant loads
        run: |
          node -e "
            const m = require('./dist-legacy-16/index.cjs');
            const count = Object.keys(m).length;
            console.log('Legacy-16 variant loaded successfully, exports:', count);
            if (count === 0) { console.error('ERROR: No exports found'); process.exit(1); }
          "
        working-directory: core/typescript

      - name: Restore package.json
        run: |
          mv package.json.backup package.json
        working-directory: core/typescript

  test-node-14:
    name: Test on Node 14 (Legacy-14)
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artk-core-variants
          path: .

      - name: Install dependencies (legacy)
        run: |
          # Use legacy-14 package.json for correct module system and Playwright version
          cp package.json package.json.backup
          cp package-legacy-14.json package.json
          npm install --legacy-peer-deps || true
        working-directory: core/typescript

      - name: Verify legacy-14 variant loads
        run: |
          node -e "
            const m = require('./dist-legacy-14/index.cjs');
            const count = Object.keys(m).length;
            console.log('Legacy-14 variant loaded successfully, exports:', count);
            if (count === 0) { console.error('ERROR: No exports found'); process.exit(1); }
          "
        working-directory: core/typescript

      - name: Restore package.json
        run: |
          mv package.json.backup package.json
        working-directory: core/typescript

  test-llkb-helper:
    name: Test LLKB Bootstrap Helper
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['14', '16', '18', '20', '22']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Test LLKB helper runs
        run: |
          # Create a test directory
          mkdir -p /tmp/test-artk-e2e/vendor/artk-core

          # Copy the helper
          cp scripts/helpers/bootstrap-llkb.cjs /tmp/test-artk-e2e/vendor/artk-core/

          # Run the helper
          node /tmp/test-artk-e2e/vendor/artk-core/bootstrap-llkb.cjs /tmp/test-artk-e2e --verbose

          # Verify files were created
          if [ ! -f "/tmp/test-artk-e2e/.artk/llkb/config.yml" ]; then
            echo "ERROR: config.yml not created"
            exit 1
          fi
          if [ ! -f "/tmp/test-artk-e2e/.artk/llkb/lessons.json" ]; then
            echo "ERROR: lessons.json not created"
            exit 1
          fi
          if [ ! -f "/tmp/test-artk-e2e/.artk/llkb/components.json" ]; then
            echo "ERROR: components.json not created"
            exit 1
          fi
          if [ ! -f "/tmp/test-artk-e2e/.artk/llkb/analytics.json" ]; then
            echo "ERROR: analytics.json not created"
            exit 1
          fi
          if [ ! -d "/tmp/test-artk-e2e/.artk/llkb/patterns" ]; then
            echo "ERROR: patterns directory not created"
            exit 1
          fi
          if [ ! -d "/tmp/test-artk-e2e/.artk/llkb/history" ]; then
            echo "ERROR: history directory not created"
            exit 1
          fi

          # Validate file contents (not just existence)
          echo "Validating file contents..."

          # config.yml must have version field
          if ! grep -q "^version:" /tmp/test-artk-e2e/.artk/llkb/config.yml; then
            echo "ERROR: config.yml missing version field"
            exit 1
          fi
          echo "  ✓ config.yml has version field"

          # JSON files must be valid and have version key
          for jsonfile in lessons.json components.json analytics.json; do
            filepath="/tmp/test-artk-e2e/.artk/llkb/$jsonfile"
            # Check valid JSON (node is available in all test environments)
            if ! node -e "JSON.parse(require('fs').readFileSync('$filepath', 'utf8'))"; then
              echo "ERROR: $jsonfile is not valid JSON"
              exit 1
            fi
            # Check version key exists
            if ! node -e "const d=JSON.parse(require('fs').readFileSync('$filepath','utf8')); if(!d.version) process.exit(1)"; then
              echo "ERROR: $jsonfile missing version field"
              exit 1
            fi
            echo "  ✓ $jsonfile is valid JSON with version field"
          done

          # Pattern files must be valid JSON
          for patternfile in selectors.json timing.json assertions.json auth.json data.json; do
            filepath="/tmp/test-artk-e2e/.artk/llkb/patterns/$patternfile"
            if [ -f "$filepath" ]; then
              if ! node -e "JSON.parse(require('fs').readFileSync('$filepath', 'utf8'))"; then
                echo "ERROR: patterns/$patternfile is not valid JSON"
                exit 1
              fi
              echo "  ✓ patterns/$patternfile is valid JSON"
            fi
          done

          echo "✓ LLKB helper works on Node ${{ matrix.node-version }}"

      - name: Test verify-only mode
        run: |
          node /tmp/test-artk-e2e/vendor/artk-core/bootstrap-llkb.cjs /tmp/test-artk-e2e --verify-only
          echo "✓ Verify-only mode works on Node ${{ matrix.node-version }}"

      - name: Test force mode
        run: |
          # Add a marker file to verify force deletes
          echo "test" > /tmp/test-artk-e2e/.artk/llkb/marker.txt

          # Run with force
          node /tmp/test-artk-e2e/vendor/artk-core/bootstrap-llkb.cjs /tmp/test-artk-e2e --force --verbose

          # Verify marker was deleted (force wipes existing)
          if [ -f "/tmp/test-artk-e2e/.artk/llkb/marker.txt" ]; then
            echo "ERROR: Force mode didn't delete existing LLKB"
            exit 1
          fi

          echo "✓ Force mode works on Node ${{ matrix.node-version }}"

      - name: Cleanup
        run: rm -rf /tmp/test-artk-e2e

  build-cli:
    name: Build CLI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: cli

      - name: Build CLI
        run: npm run build
        working-directory: cli

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artk-cli
          path: cli/dist
          retention-days: 7

  build-time-check:
    name: Verify Build Performance
    needs: build-variants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: core/typescript/package.json

      - name: Install dependencies
        run: |
          npm install
          cd autogen && npm install
        working-directory: core/typescript

      - name: Time full variant build
        run: |
          export NODE_OPTIONS="--max-old-space-size=6144"

          START=$(date +%s)

          npm run build
          npm run build:cjs
          npm run build:legacy-16
          npm run build:legacy-14

          END=$(date +%s)
          DURATION=$((END - START))

          echo "Total build time: ${DURATION}s"

          if [ "$DURATION" -gt 300 ]; then
            echo "::warning::Build exceeded 5-minute target (${DURATION}s > 300s)"
          else
            echo "✓ Build within 5-minute target"
          fi
        working-directory: core/typescript
