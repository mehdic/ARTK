name: Build IntelliJ IDEA Plugin

# Only runs manually - not on every push/PR
# To trigger: Actions ‚Üí Build IntelliJ IDEA Plugin ‚Üí Run workflow
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      publish_to_marketplace:
        description: 'Publish to JetBrains Marketplace'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.intellij_version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        intellij_version: ['2024.1', '2024.2', '2024.3', '2025.1', '2025.2', '2025.3']
      fail-fast: false
    outputs:
      version: ${{ steps.version.outputs.version }}

    defaults:
      run:
        working-directory: packages/intellij-plugin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Check plugin directory exists
        id: check_dir
        run: |
          if [ ! -f "build.gradle.kts" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå IntelliJ plugin not found at packages/intellij-plugin"
            exit 1
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Plugin directory found"
          fi

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Bump version (2024.1 only)
        id: bump
        if: matrix.intellij_version == '2024.1' && github.event.inputs.version_bump != 'none'
        run: |
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"

          # Get current version from build.gradle.kts
          CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' build.gradle.kts || echo "1.0.0")
          echo "Current version: $CURRENT_VERSION"

          # Calculate new version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          case "$BUMP_TYPE" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update build.gradle.kts
          sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" build.gradle.kts

      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP 'version = "\K[^"]+' build.gradle.kts || echo "1.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION for IntelliJ ${{ matrix.intellij_version }}"

      - name: Configure IntelliJ version
        run: |
          # Map IntelliJ version to sinceBuild number and Kotlin version
          # Kotlin versions from: https://plugins.jetbrains.com/docs/intellij/using-kotlin.html
          case "${{ matrix.intellij_version }}" in
            "2024.1") SINCE_BUILD="241"; KOTLIN_VERSION="1.9.22" ;;
            "2024.2") SINCE_BUILD="242"; KOTLIN_VERSION="1.9.24" ;;
            "2024.3") SINCE_BUILD="243"; KOTLIN_VERSION="2.0.21" ;;
            "2025.1") SINCE_BUILD="251"; KOTLIN_VERSION="2.1.10" ;;
            "2025.2") SINCE_BUILD="252"; KOTLIN_VERSION="2.1.20" ;;
            "2025.3") SINCE_BUILD="253"; KOTLIN_VERSION="2.1.20" ;;
            *) SINCE_BUILD="241"; KOTLIN_VERSION="1.9.22" ;;
          esac

          # Update intellij.version in build.gradle.kts for this matrix build
          sed -i 's/version.set("[^"]*")/version.set("${{ matrix.intellij_version }}")/' build.gradle.kts

          # Update sinceBuild to match target IntelliJ version
          sed -i "s/sinceBuild.set(\"[^\"]*\")/sinceBuild.set(\"$SINCE_BUILD\")/" build.gradle.kts

          # Update Kotlin version for compatibility
          sed -i "s/org.jetbrains.kotlin.jvm\") version \"[^\"]*\"/org.jetbrains.kotlin.jvm\") version \"$KOTLIN_VERSION\"/" build.gradle.kts

          echo "üéØ Configured for IntelliJ ${{ matrix.intellij_version }} (sinceBuild: $SINCE_BUILD, Kotlin: $KOTLIN_VERSION)"

      - name: Build plugin
        run: ./gradlew buildPlugin --no-daemon

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Verify plugin
        run: ./gradlew verifyPlugin --no-daemon

      - name: Rename artifact with IntelliJ version
        run: |
          cd build/distributions
          for f in *.zip; do
            if [ -f "$f" ]; then
              # Extract name without extension
              name="${f%.zip}"
              # Rename to include IntelliJ version
              mv "$f" "${name}-intellij-${{ matrix.intellij_version }}.zip"
              echo "üì¶ Renamed to: ${name}-intellij-${{ matrix.intellij_version }}.zip"
            fi
          done
          ls -la *.zip 2>/dev/null || echo "No zip files"

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: artk-intellij-plugin-${{ steps.version.outputs.version }}-intellij-${{ matrix.intellij_version }}
          path: packages/intellij-plugin/build/distributions/*.zip
          retention-days: 30
          if-no-files-found: error

      - name: Show build info
        run: |
          echo "üì¶ Version: ${{ steps.version.outputs.version }}"
          echo "üéØ IntelliJ: ${{ matrix.intellij_version }}"
          ls -lh build/distributions/*.zip 2>/dev/null || echo "No distribution files"

  # Aggregate all builds into a single downloadable artifact
  package:
    name: Package All Builds
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-plugins
          pattern: artk-intellij-plugin-*

      - name: List all builds
        run: |
          echo "üì¶ All plugin builds:"
          find ./all-plugins -name "*.zip" -exec ls -lh {} \;

      - name: Create combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: artk-intellij-plugin-all-versions-${{ needs.build.outputs.version }}
          path: ./all-plugins/**/*.zip
          retention-days: 30

  commit-version:
    name: Commit Version Bump
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.version_bump != 'none' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bump version in source
        run: |
          cd packages/intellij-plugin
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' build.gradle.kts || echo "1.0.0")

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          case "$BUMP_TYPE" in
            major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
            minor) NEW_VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" build.gradle.kts
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/intellij-plugin/build.gradle.kts
          git commit -m "chore(intellij): bump version to $NEW_VERSION [skip ci]" || echo "No changes"
          git push || echo "Push failed"

  publish:
    name: Publish to Marketplace
    needs: [build, package]
    runs-on: ubuntu-latest
    if: github.event.inputs.publish_to_marketplace == 'true' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download 2024.1 plugin (baseline)
        uses: actions/download-artifact@v4
        with:
          name: artk-intellij-plugin-${{ needs.build.outputs.version }}-intellij-2024.1
          path: ./packages/intellij-plugin/build/distributions

      - name: Publish to JetBrains Marketplace
        working-directory: packages/intellij-plugin
        env:
          PUBLISH_TOKEN: ${{ secrets.JETBRAINS_PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.JETBRAINS_CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.JETBRAINS_PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.JETBRAINS_PRIVATE_KEY_PASSWORD }}
        run: |
          if [ -n "$PUBLISH_TOKEN" ]; then
            ./gradlew publishPlugin
          else
            echo "‚ö†Ô∏è JETBRAINS_PUBLISH_TOKEN not configured. Skipping."
            echo "Required secrets: JETBRAINS_PUBLISH_TOKEN, JETBRAINS_CERTIFICATE_CHAIN, JETBRAINS_PRIVATE_KEY, JETBRAINS_PRIVATE_KEY_PASSWORD"
          fi

  release:
    name: Create GitHub Release
    needs: [build, package]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download all plugins
        uses: actions/download-artifact@v4
        with:
          name: artk-intellij-plugin-all-versions-${{ needs.build.outputs.version }}
          path: ./release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: intellij-v${{ needs.build.outputs.version }}
          name: IntelliJ IDEA Plugin v${{ needs.build.outputs.version }}
          body: |
            ## ARTK IntelliJ IDEA Plugin v${{ needs.build.outputs.version }}

            ### Installation

            #### From JetBrains Marketplace (Recommended)
            1. In IntelliJ IDEA, go to `Settings` ‚Üí `Plugins` ‚Üí `Marketplace`
            2. Search for "ARTK"
            3. Click `Install`

            #### Manual Installation
            1. Download the `.zip` file for your IntelliJ version below
            2. In IntelliJ IDEA, go to `Settings` ‚Üí `Plugins` ‚Üí `‚öôÔ∏è` ‚Üí `Install Plugin from Disk...`
            3. Select the downloaded file

            ### Compatibility
            - IntelliJ IDEA 2024.1 through 2025.3 (latest)
            - WebStorm, PhpStorm, PyCharm, and other JetBrains IDEs

            ### Downloads
            | IntelliJ Version | Download |
            |------------------|----------|
            | 2024.1 | `artk-intellij-plugin-*-intellij-2024.1.zip` |
            | 2024.2 | `artk-intellij-plugin-*-intellij-2024.2.zip` |
            | 2024.3 | `artk-intellij-plugin-*-intellij-2024.3.zip` |
            | 2025.1 | `artk-intellij-plugin-*-intellij-2025.1.zip` |
            | 2025.2 | `artk-intellij-plugin-*-intellij-2025.2.zip` |
            | 2025.3 | `artk-intellij-plugin-*-intellij-2025.3.zip` |

            ### Features
            - Initialize and manage ARTK projects
            - Journey management with tree views
            - LLKB (Lessons Learned Knowledge Base) integration
            - Workflow guidance with Copilot integration
            - Interactive dashboard
          files: |
            ./release/**/*.zip
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
